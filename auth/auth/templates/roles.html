{% extends "layout.html" %}
{% block title %}Roles{% endblock %}
{% block content %}


{% if all_system_role_assignments.keys().__len__() > 0 %}
<h1 class='text-2xl font-light mb-4'>System role assignments</h1>

<table class='table-auto w-full border border-slate-300 border-collapse font-inter'>
  <thead>
    <tr>
      <th class='h-12 bg-slate-200 text-center font-light border border-slate-300 px-2 w-1/4'>Role name</th>
      <th class='h-12 bg-slate-200 text-center font-light border border-slate-300 px-2 w-1/4'>Permissions</th>
      <th class='h-12 bg-slate-200 text-center font-light border border-slate-300 px-2 w-1/4'>Users</th>
    </tr>
  </thead>
  <tbody>
    {% for role in all_system_role_assignments.keys() %}
    <tr>
      <td class='text-left border border-slate-300 px-2 py-2'>{{ role.value }}</td>
      <td class='text-left border border-slate-300 px-2 py-2'>
        <ul class='list-disc list-inside'>
          {% for permission in all_system_role_assignments[role]['permissions'] %}
          <li>{{ permission }}</li>
          {% endfor %}
        </ul>
      </td>
      <td class='text-left border border-slate-300 px-2 py-2'>
        <ul class='list-disc list-inside'>
          {% for user in all_system_role_assignments[role]['users'] %}
          <li class='flex items-center justify-between'>
            <span>{{ user }}</span>
            <button 
              onclick="removeRole('{{ user }}', '{{ role.value }}')"
              class='ml-2 text-red-600 hover:text-red-800 transition-colors duration-200'
              title='Remove {{ role.value }} role from {{ user }}'
            >
              <svg class='w-4 h-4' fill='currentColor' viewBox='0 0 20 20'>
                <path fill-rule='evenodd' d='M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z' clip-rule='evenodd'></path>
              </svg>
            </button>
          </li>
          {% endfor %}
        </ul>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<script>
async function removeRole(username, roleName) {
  if (!confirm(`Are you sure you want to remove the '${roleName}' role from user '${username}'?`)) {
    return;
  }

  try {
    const response = await fetch(`{{ base_path }}/api/v1alpha/system_roles/${username}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        role_removal: roleName
      })
    });

    if (response.ok) {
      // Refresh the page to show updated data
      window.location.reload();
    } else {
      const errorData = await response.json().catch(() => ({}));
      alert(`Failed to remove role: ${errorData.message || response.statusText}`);
    }
  } catch (error) {
    console.error('Error removing role:', error);
    alert('Failed to remove role. Please try again.');
  }
}
</script>
{% endblock %}
