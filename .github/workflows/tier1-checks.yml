name: CI / Tier 1 Checks

on:
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same PR
concurrency:
  group: tier1-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PYTHONPATH: hail/python:auth:batch:ci:gear:monitoring:website:web_common

jobs:
  check-pip-requirements:
    name: Check pip requirements
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: pip
          cache-dependency-path: '**/pinned-requirements.txt'

      - name: Install uv
        run: pip install uv

      - name: Check pinned requirements are up to date
        run: |
          chmod 755 ./check_pip_requirements.sh
          make check-pip-requirements

  check-services:
    name: Check services
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      HAIL_TARGET_SHA: ${{ github.event.pull_request.base.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          # check-sql.sh needs git history to diff against target
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: '**/pinned-requirements.txt'

      - name: Install Python dependencies
        run: |
          pip install \
            -r hail/python/pinned-requirements.txt \
            -r hail/python/dev/pinned-requirements.txt \
            -r gear/pinned-requirements.txt \
            -r web_common/pinned-requirements.txt \
            -r batch/pinned-requirements.txt \
            -r ci/pinned-requirements.txt

      - name: Run check-services
        run: make -k check-services

  check-hail:
    name: Check hail
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: '**/pinned-requirements.txt'

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Mill
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/mill
            hail/out
          key: mill-${{ runner.os }}-${{ hashFiles('hail/build.mill') }}
          restore-keys: mill-${{ runner.os }}-

      - name: Install Python dependencies
        run: |
          pip install \
            -r hail/python/pinned-requirements.txt \
            -r hail/python/dev/pinned-requirements.txt \
            -r gear/pinned-requirements.txt \
            -r web_common/pinned-requirements.txt \
            -r batch/pinned-requirements.txt \
            -r ci/pinned-requirements.txt

      - name: Run check-hail
        run: make check-hail MILLOPTS=--no-daemon

  test-gcp-ar-cleanup:
    name: Test GCP AR cleanup policies
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pyyaml
        run: pip install pyyaml

      - name: Check AR cleanup policy is up to date
        run: |
          new_policy=$(mktemp)
          python3 devbin/generate_gcp_ar_cleanup_policy.py > "$new_policy"
          diff "$new_policy" infra/gcp-broad/gcp-ar-cleanup-policy.txt || {
            echo '>>> AR cleanup policy has changed, new policy is <<<'
            cat "$new_policy"
            echo '--------------------------------------'
            echo "Please regenerate the policy file by running:"
            echo "> python3 devbin/generate_gcp_ar_cleanup_policy.py > infra/gcp-broad/gcp-ar-cleanup-policy.txt"
            exit 1
          }

  compile-hail-213:
    name: Compile Hail (Scala 2.13)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Cache Mill
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/mill
            hail/out
          key: mill-${{ runner.os }}-${{ hashFiles('hail/build.mill') }}
          restore-keys: mill-${{ runner.os }}-

      - name: Compile Scala 2.13
        working-directory: hail
        run: HAIL_BUILD_MODE=CI SCALA_VERSION=2.13 sh mill --no-daemon hail[2.13].__.compile

  test-ci-unit:
    name: Test CI unit
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: '**/pinned-requirements.txt'

      - name: Install Python dependencies
        run: |
          pip install \
            -r hail/python/hailtop/pinned-requirements.txt \
            -r hail/python/dev/pinned-requirements.txt \
            -r gear/pinned-requirements.txt \
            -r web_common/pinned-requirements.txt \
            -r ci/pinned-requirements.txt

      - name: Install packages
        run: |
          pip install uv_build
          # hailtop's setup.py lives at a non-standard path; create a temp
          # installable directory mirroring what the CI Dockerfile does.
          tmp_hailtop=$(mktemp -d)
          cp hail/python/setup-hailtop.py "$tmp_hailtop/setup.py"
          cp hail/python/MANIFEST.in "$tmp_hailtop/MANIFEST.in"
          ln -s "$PWD/hail/python/hailtop" "$tmp_hailtop/hailtop"
          pip install --no-deps "$tmp_hailtop" ./gear ./web_common ./ci

      - name: Run CI unit tests
        run: |
          python3 -m pytest \
            -Werror:::hail -Werror:::hailtop -Werror::ResourceWarning \
            --log-cli-level=INFO \
            -s \
            -r A \
            -vv \
            --instafail \
            --durations=50 \
            ci/unit-test

  tier1-result:
    name: Tier 1 Result
    if: always()
    needs:
      - check-pip-requirements
      - check-services
      - check-hail
      - test-gcp-ar-cleanup
      - compile-hail-213
      - test-ci-unit
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Verify all checks passed
        run: |
          results=( \
            "${{ needs.check-pip-requirements.result }}" \
            "${{ needs.check-services.result }}" \
            "${{ needs.check-hail.result }}" \
            "${{ needs.test-gcp-ar-cleanup.result }}" \
            "${{ needs.compile-hail-213.result }}" \
            "${{ needs.test-ci-unit.result }}" \
          )
          for r in "${results[@]}"; do
            if [[ "$r" != "success" ]]; then
              echo "One or more Tier 1 checks failed or were cancelled."
              exit 1
            fi
          done
          echo "All Tier 1 checks passed."
